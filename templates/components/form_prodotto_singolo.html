<div class="card mb-4 shadow-sm product-card" data-tab-index="{{ tab_index }}" data-tab-type="single_product">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">Prodotto Singolo</h5>
        <button type="button" class="btn btn-sm btn-outline-danger remove-tab-btn">
            <i class="fas fa-times"></i> Rimuovi
        </button>
    </div>
    <div class="card-body">
        <input type="hidden" name="tab_{{ tab_index }}type_" value="single_product">
        
        <div class="row mb-3">
            <div class="col-md-2">
                <label for="posizione_{{ tab_index }}" class="form-label">Posizione</label>
                <input type="text" class="form-control" id="posizione_{{ tab_index }}" name="posizione_{{ tab_index }}" 
                    value="{{ tab.posizione|default('') if tab else '' }}">
            </div>
            <div class="col-md-5">
                <label for="product_{{ tab_index }}name_" class="form-label">Nome Prodotto</label>
                <input type="text" class="form-control" id="product_{{ tab_index }}name_" name="product_{{ tab_index }}name_" required
                    value="{{ tab.product_name|default('') if tab else '' }}">
            </div>
            <div class="col-md-5">
                <label for="product_{{ tab_index }}code_" class="form-label theme-sensitive-text">Modello (uso interno)</label>
                <input type="text" class="form-control theme-sensitive-input fst-italic" id="product_{{ tab_index }}code_" name="product_{{ tab_index }}code_"
                    value="{{ tab.product_code|default('') if tab else '' }}" placeholder="Solo per riferimento interno" title="Solo per riferimento interno">
            </div>
        </div>
        
        <div class="row mb-3">
            <div class="col-md-4">
                <label for="volts_{{ tab_index }}" class="form-label">Tensione (V)</label>
                <input type="text" class="form-control" id="volts_{{ tab_index }}" name="volts_{{ tab_index }}"
                    value="{{ tab.volts|default('') if tab else '' }}">
            </div>
            <div class="col-md-4">
                <label for="power_{{ tab_index }}w_" class="form-label">Potenza (W)</label>
                <input type="text" class="form-control" id="power_{{ tab_index }}w_" name="power_{{ tab_index }}w_"
                    value="{{ tab.power_w|default('') if tab else '' }}">
            </div>
            <div class="col-md-4">
                <label for="size_{{ tab_index }}" class="form-label">Dimensioni (LxPxH)</label>
                <input type="text" class="form-control" id="size_{{ tab_index }}" name="size_{{ tab_index }}"
                    value="{{ tab.size|default('') if tab else '' }}">
            </div>
        </div>
        
        <div class="row mb-3">
            <div class="col-md-6">
                <label for="unit_{{ tab_index }}price_" class="form-label">Prezzo Unitario (€)</label>
                <input type="number" step="0.01" min="0" class="form-control" id="unit_{{ tab_index }}price_" name="unit_{{ tab_index }}price_" required
                    value="{{ tab.unit_price|default('0.00') if tab else '0.00' }}">
            </div>
            <div class="col-md-6">
                <label for="quantity_{{ tab_index }}" class="form-label">Quantità</label>
                <input type="number" step="1" min="1" class="form-control" id="quantity_{{ tab_index }}" name="quantity_{{ tab_index }}" required
                    value="{{ tab.quantity|default('1') if tab else '1' }}">
            </div>
        </div>
        
        <div class="row mb-3">
            <div class="col-md-6">
                <label for="discount_{{ tab_index }}" class="form-label">Sconto (%)</label>
                <div class="input-group">
                    <input type="number" step="0.01" min="0" max="100" class="form-control" id="discount_{{ tab_index }}" name="discount_{{ tab_index }}"
                        value="{{ tab.discount|default('0') if tab else '0' }}" oninput="updateDiscountedPrice({{ tab_index }})">
                    <span class="input-group-text">%</span>
                </div>
                <div class="mt-2">
                    <small class="text-muted">Prezzo scontato: <span id="discounted_price_{{ tab_index }}" class="text-success fw-bold">-</span></small>
                </div>
            </div>
            <div class="col-md-6 d-flex align-items-end">
                <div class="form-check mt-3">
                    <input class="form-check-input discount-checkbox" type="checkbox" id="discount_flag_{{ tab_index }}" name="discount_{{ tab_index }}flag_"
                        {{ 'checked' if tab and tab.discount_flag else '' }} onchange="toggleDiscount(this); updateDiscountedPrice({{ tab_index }});">
                    <label class="form-check-label" for="discount_flag_{{ tab_index }}">
                        Applicare sconto
                    </label>
                </div>
            </div>
        </div>        
        
        <div class="mb-3">
            <label for="description_{{ tab_index }}" class="form-label">Descrizione Prodotto</label>
            <textarea class="form-control auto-expand description-input" 
                      id="description_{{ tab_index }}" 
                      name="description_{{ tab_index }}" 
                      rows="4">{{ tab.description|default('') if tab is defined and tab else '' }}</textarea>
        </div>
        
        <div class="mb-3">
            <label for="product_image_{{ tab_index }}" class="form-label">Immagine Prodotto</label>
            <input type="file" class="form-control" id="product_image_{{ tab_index }}" name="product_{{ tab_index }}image_" accept="image/*">
            {% if tab and tab.product_image_path %}
                <div class="mt-2">
                    <img src="{{ tab.product_image_path }}" alt="Immagine prodotto" class="img-thumbnail" style="max-height: 100px;">
                    <input type="hidden" name="existing_image_{{ tab_index }}" value="{{ tab.product_image_path }}">
                </div>
            {% endif %}
        </div>
        
        <!-- New Accessories Section -->
        <div class="mt-4 border-top pt-3">
            <h5>Accessori (uso interno)</h5>
            <p class="text-muted small theme-sensitive-text">Gli accessori sono visibili solo internamente e non vengono inclusi nel PDF cliente o nel prezzo totale</p>
            
            <div id="accessories_list_{{ tab_index }}" class="mb-3">
                <table class="table table-sm table-bordered" id="accessories_table_{{ tab_index }}">
                    <thead class="table-light">
                        <tr>
                            <th>Nome Accessorio</th>
                            <th>Codice</th>
                            <th>Prezzo (€)</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if tab and tab.accessories %}
                            {% for accessory in tab.accessories %}
                                <tr>
                                    <td>{{ accessory.name }}</td>
                                    <td>{{ accessory.code }}</td>
                                    <td>{{ accessory.price }}</td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-outline-danger remove-accessory-btn">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            {% endfor %}
                        {% endif %}
                    </tbody>
                </table>
            </div>
            
            <div class="row g-3 mb-3" id="accessory_form_{{ tab_index }}">
                <div class="col-md-4">
                    <input type="text" class="form-control form-control-sm" id="accessory_name_{{ tab_index }}" placeholder="Nome accessorio">
                </div>
                <div class="col-md-3">
                    <input type="text" class="form-control form-control-sm" id="accessory_code_{{ tab_index }}" placeholder="Codice">
                </div>
                <div class="col-md-3">
                    <input type="number" step="0.01" min="0" class="form-control form-control-sm" id="accessory_price_{{ tab_index }}" placeholder="Prezzo">
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-sm btn-primary add-accessory-btn" data-tab-index="{{ tab_index }}">
                        <i class="fas fa-plus"></i> Aggiungi
                    </button>
                </div>
            </div>
            
            <!-- Hidden input to store accessories as JSON -->
            <input type="hidden" id="accessories_data_{{ tab_index }}" name="accessories_{{ tab_index }}" value="{{ tab.accessories|tojson if tab and tab.accessories else '[]' }}">
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Setup accessory management for this form
        setupAccessoryManagement({{ tab_index }});
        
        // Inizializza il calcolo del prezzo scontato
        setTimeout(function() {
            updateDiscountedPrice({{ tab_index }});
        }, 100);
    });

    // Esegui anche all'interno del template per essere sicuri che funzioni sempre
    setTimeout(function() {
        if (typeof updateDiscountedPrice === 'function') {
            updateDiscountedPrice({{ tab_index }});
        }
        if (typeof setupAccessoryManagement === 'function') {
            setupAccessoryManagement({{ tab_index }});
        }
    }, 500);
</script>