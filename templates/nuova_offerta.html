{% extends "layout.html" %}

{% block title %}{{ 'Modifica Offerta' if is_edit else 'Nuova Offerta' }} - Generatore Offerte Valtservice{% endblock %}

{% block extra_css %}
<style>
    .product-card {
        transition: all 0.3s ease;
    }
    .product-card:hover {
        box-shadow: 0 .5rem 1rem rgba(0,0,0,.15)!important;
    }
    .remove-tab-btn:hover, .remove-product-btn:hover {
        transform: scale(1.05);
    }

    /* Stili per il layout a due colonne */
    #mainContainer {
        transition: all 0.3s ease;
        width: 100%;
    }
    
    /* Stili per il pannello di anteprima PDF */
    #pdfPreviewPanel {
        width: 45%;
        height: 100vh;
        background-color: white;
        box-shadow: -2px 0 5px rgba(0,0,0,0.3);
        transition: all 0.3s ease;
        display: none;
        position: sticky;
        top: 0;
        overflow-y: auto;
    }
    
    /* Quando l'anteprima è attiva */
    .preview-active #mainContainer {
        width: 55%;
    }
    
    .preview-active #pdfPreviewPanel {
        display: block;
    }
    
    #pdfPreviewFrame {
        width: 100%;
        height: calc(100vh - 110px); /* Altezza che copre l'intera viewport meno intestazione e piè di pagina */
        border: none;
    }
    
    #previewLoadingIndicator {
        display: none;
        justify-content: center;
        align-items: center;
        height: 100%;
    }
    
    #previewErrorContainer {
        display: none;
    }
    
    /* Stile per il pulsante di anteprima ingrandito */
    #togglePreviewBtn {
        padding: 12px 20px;
        font-size: 1.1rem;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    /* Stili responsive */
    @media (max-width: 992px) {
        .preview-active #mainContainer,
        #pdfPreviewPanel {
            width: 100%;
        }
        
        .preview-active #pdfPreviewPanel {
            position: fixed;
            left: 0;
            top: 0;
            z-index: 1050;
            height: 100vh;
        }
        
        #pdfPreviewFrame {
            height: calc(100% - 120px);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex flex-column flex-lg-row h-100">
    <!-- Contenitore principale (form) -->
    <div id="mainContainer" class="pe-0 pe-lg-3">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3">{{ 'Modifica Offerta' if is_edit else 'Nuova Offerta' }}</h1>
            <div class="d-flex gap-2">
                <button type="button" class="btn btn-outline-secondary" onclick="window.history.back();">
                    <i class="fas fa-arrow-left me-1"></i> Indietro
                </button>
                <!-- Pulsante di anteprima ingrandito e più visibile -->
                <button id="togglePreviewBtn" class="btn btn-primary">
                    <i class="fas fa-file-pdf me-2"></i> Anteprima PDF
                </button>
            </div>
        </div>

        <form action="{{ url_for('edit_offerta', offerta_id=offerta.id) if is_edit else url_for('nuova_offerta') }}" method="post" enctype="multipart/form-data" id="offerForm">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">Informazioni Offerta</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label for="date" class="form-label">Data</label>
                            <input type="date" class="form-control" id="date" name="date" required
                                   value="{{ offerta.date if is_edit else today_date }}">
                        </div>
                        <div class="col-md-4">
                            <label for="offer_number" class="form-label">Numero Offerta</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="offer_number" name="offer_number" 
                                       value="{{ offerta.offer_number if is_edit else next_number }}">
                                <div class="input-group-text">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="update_counter" name="update_counter">
                                        <label class="form-check-label" for="update_counter">Aggiorna contatore</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-5">
                            <label for="customer" class="form-label">Cliente</label>
                            <input type="text" class="form-control" id="customer" name="customer" required
                                   value="{{ offerta.customer if is_edit else '' }}">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="customer_email" class="form-label">Email Cliente</label>
                            <input type="email" class="form-control" id="customer_email" name="customer_email"
                                   value="{{ offerta.customer_email if is_edit else '' }}">
                        </div>
                        <div class="col-md-6">
                            <label for="address" class="form-label">Indirizzo</label>
                            <input type="text" class="form-control" id="address" name="address"
                                   value="{{ offerta.address if is_edit else '' }}">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="offer_description" class="form-label">Descrizione Offerta</label>
                        <div class="position-relative">
                            <textarea class="form-control" id="offer_description" name="offer_description" 
                                      rows="4" onkeyup="updateCharCount(this)">{{ offerta.offer_description if offerta else '' }}</textarea>
                            <small class="text-muted position-absolute bottom-0 end-0 mb-2 me-2">
                                <span id="charCount">0</span>/1200 caratteri (inclusi spazi e ritorni a capo)
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="h4">Schede Prodotto</h3>
                <div class="btn-group">
                    <button type="button" class="btn btn-outline-primary" id="addSingleProductBtn">
                        <i class="fas fa-plus"></i> Aggiungi Prodotto Singolo
                    </button>
                    <button type="button" class="btn btn-outline-primary" id="addMultiProductBtn">
                        <i class="fas fa-plus"></i> Aggiungi Multiprodotto
                    </button>
                </div>
            </div>
            
            <div id="tabsContainer">
                {% if is_edit and offerta.tabs %}
                    {% for tab in offerta.tabs %}
                        {% set tab_index = loop.index0 %}
                        {% if tab.type == 'single_product' %}
                            {% include 'components/form_prodotto_singolo.html' with context %}
                        {% elif tab.type == 'multi_product' %}
                            {% include 'components/form_multiprodotto.html' with context %}
                        {% endif %}
                    {% endfor %}
                {% endif %}
            </div>
            
            <input type="hidden" name="tab_count" id="tabCount" value="{{ offerta.tabs|length if is_edit and offerta.tabs else 0 }}">
            
            <div class="text-center my-4">
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="fas fa-save me-2"></i> {{ 'Aggiorna Offerta' if is_edit else 'Genera Offerta' }}
                </button>
            </div>
        </form>
    </div>

    <!-- Pannello di anteprima PDF -->
    <div id="pdfPreviewPanel" class="bg-white shadow">
        <div class="d-flex flex-column h-100">
            <div class="p-2 bg-light border-bottom d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-file-pdf text-danger me-2"></i> Anteprima PDF</h5>
                <button type="button" class="btn-close" id="closePreviewBtn"></button>
            </div>
            <div class="p-2 bg-light border-bottom">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="autoUpdatePreview">
                    <label class="form-check-label" for="autoUpdatePreview">Aggiornamento automatico</label>
                </div>
                <small class="text-muted d-block">L'anteprima si aggiorna automaticamente mentre compili il form</small>
            </div>
            <div class="p-2 flex-grow-1 d-flex flex-column" style="min-height: 0;">
                <div id="previewLoadingIndicator" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Caricamento...</span>
                    </div>
                    <p class="mt-2">Generazione anteprima in corso...</p>
                </div>
                <div id="previewErrorContainer" class="alert alert-danger mt-2" style="display: none;">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span id="previewErrorMessage">Errore nella generazione dell'anteprima</span>
                </div>
                <iframe id="pdfPreviewFrame" class="w-100 flex-grow-1" style="display: none;"></iframe>
            </div>
            <div class="p-2 bg-light border-top">
                <button id="updatePdfBtn" class="btn btn-primary btn-sm me-2">
                    <i class="fas fa-sync-alt me-1"></i> Aggiorna PDF
                </button>
                <small class="text-muted ms-2">Ultimo aggiornamento: <span id="lastUpdateTime">-</span></small>
            </div>
        </div>
    </div>
</div>

<!-- Template per nuove schede (nascosti) -->
<div id="singleProductTemplate" class="d-none">
    {% include 'components/form_prodotto_singolo.html' with context %}
</div>

<div id="multiProductTemplate" class="d-none">
    {% include 'components/form_multiprodotto.html' with context %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Assicuriamo che le funzioni globali siano disponibili
    if (typeof updateDiscountedPrice !== 'function') {
        console.error('updateDiscountedPrice function not available. Check that main.js is loaded correctly.');
    }
    
    if (typeof setupAccessoryManagement !== 'function') {
        console.error('setupAccessoryManagement function not available. Check that accessory-manager.js is loaded correctly.');
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        const tabsContainer = document.getElementById('tabsContainer');
        const tabCount = document.getElementById('tabCount');
        let currentTabIndex = parseInt(tabCount.value) || 0;
        
        console.log("Inizializzazione pagina - currentTabIndex:", currentTabIndex);
        
        // Immediatamente dopo il caricamento, assicuriamoci che tutti i tab abbiano indici corretti
        updateTabIndices();
        
        // Aggiungi una scheda prodotto singolo
        document.getElementById('addSingleProductBtn').addEventListener('click', function() {
            // Clone e modifica il template
            const template = document.getElementById('singleProductTemplate').innerHTML;
            const modifiedTemplate = template.replace(/\{\{ tab_index \}\}/g, currentTabIndex);
            
            // Crea un elemento temporaneo per l'inserimento nel DOM
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = modifiedTemplate;
            
            // Aggiungi al container solo il primo figlio
            const newElement = tempDiv.firstElementChild;
            tabsContainer.appendChild(newElement);
            
            // Incremento dell'indice
            currentTabIndex++;
            tabCount.value = currentTabIndex;
            console.log("Aggiunta scheda singolo prodotto - nuovo tabCount:", tabCount.value);
            
            // Aggiungi event listener al nuovo pulsante di rimozione
            addRemoveTabEventListener();
            
            // Inizializza la funzione toggleDiscount per questa scheda
            const newCheckbox = newElement.querySelector('.discount-checkbox');
            const newDiscountInput = newElement.querySelector(`#discount_${currentTabIndex - 1}`);
            if (newCheckbox && newDiscountInput) {
                newCheckbox.addEventListener('change', function() {
                    newDiscountInput.disabled = !this.checked;
                });
                // Imposta lo stato iniziale
                newDiscountInput.disabled = !newCheckbox.checked;
            }
            
            // Aggiorna tutti gli indici per essere sicuri
            updateTabIndices();
            
            // Inizializza sconto e accessori per la nuova scheda
            setTimeout(() => {
                initializeNewTab(newElement);
            }, 200);
        });
        
        // Aggiungi una scheda multiprodotto
        document.getElementById('addMultiProductBtn').addEventListener('click', function() {
            // Clone e modifica il template
            const template = document.getElementById('multiProductTemplate').innerHTML;
            const modifiedTemplate = template.replace(/\{\{ tab_index \}\}/g, currentTabIndex);
            
            // Crea un elemento temporaneo per l'inserimento nel DOM
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = modifiedTemplate;
            
            // Aggiungi al container solo il primo figlio
            const newElement = tempDiv.firstElementChild;
            tabsContainer.appendChild(newElement);
            
            // Incremento dell'indice
            currentTabIndex++;
            tabCount.value = currentTabIndex;
            console.log("Aggiunta scheda multiprodotto - nuovo tabCount:", tabCount.value);
            
            // Aggiungi event listener al nuovo pulsante di rimozione
            addRemoveTabEventListener();
            
            // Inizializza event listeners per i prodotti in multiprodotto
            initMultiProductListeners(currentTabIndex - 1);
            
            // Aggiorna tutti gli indici per essere sicuri
            updateTabIndices();
        });
        
        // Funzione per aggiungere event listener ai pulsanti di rimozione
        function addRemoveTabEventListener() {
            document.querySelectorAll('.remove-tab-btn').forEach(button => {
                // Rimuovi eventuali event listener esistenti per evitare duplicazioni
                button.removeEventListener('click', removeTabHandler);
                // Aggiungi il nuovo event listener
                button.addEventListener('click', removeTabHandler);
            });
        }
        
        // Handler per la rimozione di schede
        function removeTabHandler() {
            const card = this.closest('.product-card');
            card.remove();
            
            // Aggiorna gli indici delle schede
            updateTabIndices();
        }
        
        // Aggiorna gli indici delle schede dopo la rimozione
        function updateTabIndices() {
            const cards = document.querySelectorAll('.product-card');
            cards.forEach((card, index) => {
                const oldIndex = card.getAttribute('data-tab-index');
                const tabType = card.getAttribute('data-tab-type');
                
                console.log(`Aggiornamento indice da ${oldIndex} a ${index} per scheda di tipo ${tabType}`);
                
                // Aggiorna l'attributo data-tab-index
                card.setAttribute('data-tab-index', index);
                
                // Aggiorna tutti gli input con il nuovo indice
                card.querySelectorAll('input, select, textarea').forEach(input => {
                    const name = input.getAttribute('name');
                    if (name && name.includes('_' + oldIndex)) {
                        input.setAttribute('name', name.replace('_' + oldIndex, '_' + index));
                    }
                    
                    const id = input.getAttribute('id');
                    if (id && id.includes('_' + oldIndex)) {
                        const newId = id.replace('_' + oldIndex, '_' + index);
                        input.setAttribute('id', newId);
                        
                        // Aggiorna anche le label associate
                        const label = card.querySelector(`label[for="${id}"]`);
                        if (label) {
                            label.setAttribute('for', newId);
                        }
                    }
                });
                
                // Aggiorna il tipo di tab - questo è fondamentale!
                const tabTypeInputName = `tab_type_${index}`;
                let tabTypeInput = card.querySelector(`input[name="${tabTypeInputName}"]`);
                
                // Se non esiste il campo, lo creiamo
                if (!tabTypeInput) {
                    tabTypeInput = document.createElement('input');
                    tabTypeInput.type = 'hidden';
                    card.appendChild(tabTypeInput);
                }
                
                // Imposta il nome corretto e il valore
                tabTypeInput.name = tabTypeInputName;
                tabTypeInput.value = tabType;
                
                console.log(`Impostato campo tab_type_${index} = ${tabType}`);
                
                // Gestione speciale per multiprodotto
                if (tabType === 'multi_product') {
                    const table = card.querySelector(`table[id="products_table_${oldIndex}"]`);
                    if (table) {
                        table.id = `products_table_${index}`;
                    }
                    
                    const productCount = card.querySelector(`input[id="product_count_${oldIndex}"]`);
                    if (productCount) {
                        productCount.id = `product_count_${index}`;
                        productCount.name = `product_count_${index}`;
                    }
                    
                    const addProductBtn = card.querySelector('.add-product-btn');
                    if (addProductBtn) {
                        addProductBtn.setAttribute('data-tab-index', index);
                    }
                    
                    // Aggiorna gli indici dei prodotti nella tabella
                    const productRows = card.querySelectorAll('.product-row');
                    productRows.forEach((row, rowIndex) => {
                        row.querySelectorAll('input').forEach(input => {
                            const nameParts = input.name.split('_');
                            if (nameParts.length >= 3 && nameParts[1] == oldIndex) {
                                nameParts[1] = index;
                                input.name = nameParts.join('_');
                            }
                        });
                    });
                }
            });
            
            // Aggiorna il contatore totale
            currentTabIndex = cards.length;
            tabCount.value = currentTabIndex;
            console.log("Indici aggiornati, nuovo tabCount:", tabCount.value);
        }
        
        // Inizializza la funzione toggleDiscount per tutte le schede esistenti
        function initToggleDiscount(index) {
            const checkbox = document.getElementById(`discount_flag_${index}`);
            const discountInput = document.getElementById(`discount_${index}`);
            if (checkbox && discountInput) {
                checkbox.addEventListener('change', function() {
                    discountInput.disabled = !this.checked;
                });
                // Imposta lo stato iniziale
                discountInput.disabled = !checkbox.checked;
            }
        }
        
        // Inizializza event listeners per i prodotti in multiprodotto
        function initMultiProductListeners(tabIndex) {
            // Trova il pulsante per aggiungere prodotti
            const addProductBtn = document.querySelector(`.add-product-btn[data-tab-index="${tabIndex}"]`);
            
            if (addProductBtn) {
                // Rimuovi eventuali event listener esistenti
                addProductBtn.removeEventListener('click', addProductHandler);
                // Aggiungi nuovo event listener
                addProductBtn.addEventListener('click', addProductHandler);
            }
            
            // Aggiungi event listeners ai pulsanti di rimozione prodotto esistenti
            const productTable = document.getElementById(`products_table_${tabIndex}`);
            if (productTable) {
                productTable.querySelectorAll('.remove-product-btn').forEach(button => {
                    // Rimuovi eventuali listener esistenti
                    button.removeEventListener('click', removeProductHandler);
                    // Aggiungi nuovo listener
                    button.addEventListener('click', removeProductHandler);
                });
            }
        }
        
        // Handler per l'aggiunta di prodotti in multiprodotto
        function addProductHandler() {
            const tabIndex = this.getAttribute('data-tab-index');
            const table = document.getElementById(`products_table_${tabIndex}`);
            const productCount = document.getElementById(`product_count_${tabIndex}`);
            const newIndex = parseInt(productCount.value);
            
            const newRow = document.createElement('tr');
            newRow.className = 'product-row';
            newRow.innerHTML = `
                <td>
                    <input type="text" class="form-control" name="product_name_${tabIndex}_${newIndex}" required>
                </td>
                <td>
                    <input type="text" class="form-control" name="product_model_${tabIndex}_${newIndex}" required>
                </td>
                <td>
                    <input type="number" step="0.01" min="0" class="form-control" name="product_price_${tabIndex}_${newIndex}" value="0.00" required>
                </td>
                <td>
                    <input type="number" step="1" min="1" class="form-control" name="product_quantity_${tabIndex}_${newIndex}" value="1" required>
                </td>
                <td>
                    <input type="text" class="form-control" name="product_description_${tabIndex}_${newIndex}">
                </td>
                <td>
                    <button type="button" class="btn btn-sm btn-outline-danger remove-product-btn">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            
            table.querySelector('tbody').appendChild(newRow);
            productCount.value = newIndex + 1;
            
            // Aggiungi l'event listener al nuovo pulsante di rimozione
            const removeBtn = newRow.querySelector('.remove-product-btn');
            removeBtn.addEventListener('click', removeProductHandler);
        }
        
        // Handler per la rimozione di prodotti dalla tabella
        function removeProductHandler() {
            const row = this.closest('tr');
            const table = row.closest('table');
            const tabIndex = table.id.replace('products_table_', '');
            
            // Non rimuovere l'ultima riga
            if (table.querySelectorAll('tbody tr').length > 1) {
                row.remove();
                
                // Aggiorna il contatore e rinumera gli indici
                updateProductIndices(table, tabIndex);
            } else {
                // Se è l'ultima riga, pulisci solo i campi
                row.querySelectorAll('input').forEach(input => {
                    input.value = input.type === 'number' ? (input.name.includes('quantity') ? '1' : '0.00') : '';
                });
            }
        }
        
        // Aggiorna gli indici dei prodotti dopo la rimozione
        function updateProductIndices(table, tabIndex) {
            const rows = table.querySelectorAll('tbody tr');
            const productCount = document.getElementById(`product_count_${tabIndex}`);
            
            rows.forEach((row, index) => {
                row.querySelectorAll('input').forEach(input => {
                    const nameParts = input.name.split('_');
                    nameParts[nameParts.length - 1] = index;
                    input.name = nameParts.join('_');
                });
            });
            
            productCount.value = rows.length;
        }
        
        // Aggiungi event listener ai pulsanti di rimozione esistenti e inizializza altre funzioni
        addRemoveTabEventListener();
        
        // Inizializza eventi per tutte le schede esistenti
        document.querySelectorAll('.product-card').forEach(card => {
            const index = card.getAttribute('data-tab-index');
            const type = card.getAttribute('data-tab-type');
            
            if (type === 'single_product') {
                initToggleDiscount(index);
            } else if (type === 'multi_product') {
                initMultiProductListeners(index);
            }
        });
        
        // Convalida del form prima dell'invio
        document.getElementById('offerForm').addEventListener('submit', function(event) {
            const cards = document.querySelectorAll('.product-card');
            if (cards.length === 0) {
                event.preventDefault();
                alert('Devi aggiungere almeno una scheda prodotto!');
            } else {
                // Controlla e aggiorna il valore tab_count
                tabCount.value = cards.length;
                console.log("Form submission - tabCount set to:", tabCount.value);
                
                // Assicurati che tutti gli indici siano corretti prima dell'invio
                updateTabIndices();
                
                // Debug - mostra tutti i campi del form prima dell'invio
                console.log("Form submission - campi del form:");
                const formData = new FormData(this);
                for (var pair of formData.entries()) {
                    console.log(pair[0] + ': ' + pair[1]);
                }
            }
        });
        
        // Assicurati che gli indici siano aggiornati all'inizio
        updateTabIndices();
    });
    
    // Chiama setupDiscountCalculation quando la pagina è caricata
    if (typeof setupDiscountCalculation === 'function') {
        setupDiscountCalculation();
    }
</script>

<script>
// Funzione globale per gestire il toggle dello sconto
function toggleDiscount(checkbox) {
    const index = checkbox.id.replace('discount_flag_', '');
    const discountInput = document.getElementById('discount_' + index);
    
    if (discountInput) {
        discountInput.disabled = !checkbox.checked;
        console.log("Toggle sconto per indice " + index + ": " + checkbox.checked);
    }
}

// Inizializza tutti i checkbox dello sconto
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.discount-checkbox').forEach(function(checkbox) {
        // Imposta lo stato iniziale di tutti i campi sconto
        toggleDiscount(checkbox);
    });
});

// Funzione per aggiornare il conteggio dei caratteri
function updateCharCount(textarea) {
    const maxLength = 1200;  // Updated from 1751 to 1000
    // Count actual length including newlines
    const currentLength = textarea.value.length;
    const charCountElement = document.getElementById('charCount');
    
    charCountElement.textContent = currentLength;
    
    // Cambia colore quando ci si avvicina al limite
    if (currentLength >= maxLength - 100) {
        charCountElement.style.color = 'red';
    } else if (currentLength >= maxLength - 300) {
        charCountElement.style.color = 'orange';
    } else {
        charCountElement.style.color = 'inherit';
    }
    
    // Impedisci l'inserimento di ulteriori caratteri se si raggiunge il limite
    if (currentLength > maxLength) {
        textarea.value = textarea.value.substring(0, maxLength);
        charCountElement.textContent = maxLength;
    }
}

// Inizializza il contatore al caricamento della pagina
document.addEventListener('DOMContentLoaded', function() {
    const textarea = document.getElementById('offer_description');
    if (textarea) {
        updateCharCount(textarea);
    }
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const togglePreviewBtn = document.getElementById('togglePreviewBtn');
    const closePreviewBtn = document.getElementById('closePreviewBtn');
    const pdfPreviewPanel = document.getElementById('pdfPreviewPanel');
    const pdfPreviewFrame = document.getElementById('pdfPreviewFrame');
    const updatePdfBtn = document.getElementById('updatePdfBtn');
    const autoUpdateCheckbox = document.getElementById('autoUpdatePreview');
    const previewLoadingIndicator = document.getElementById('previewLoadingIndicator');
    const previewErrorContainer = document.getElementById('previewErrorContainer');
    const previewErrorMessage = document.getElementById('previewErrorMessage');
    const lastUpdateTime = document.getElementById('lastUpdateTime');
    const mainContainer = document.getElementById('mainContainer');
    const bodyElement = document.querySelector('body');
    
    let previewUpdateTimer = null;
    let isGeneratingPreview = false;
    
    // Toggle preview panel
    togglePreviewBtn.addEventListener('click', function() {
        bodyElement.classList.toggle('preview-active');
        
        // Generate preview on first open if not already visible
        if (bodyElement.classList.contains('preview-active') && 
            (pdfPreviewFrame.style.display === 'none' || !pdfPreviewFrame.src)) {
            generatePdfPreview();
        }
        
        // Scroll to top when toggling preview
        window.scrollTo(0, 0);
    });
    
    // Close preview panel
    closePreviewBtn.addEventListener('click', function() {
        bodyElement.classList.remove('preview-active');
    });
    
    // Manual update PDF button
    updatePdfBtn.addEventListener('click', function() {
        generatePdfPreview();
    });
    
    // Toggle auto-update
    autoUpdateCheckbox.addEventListener('change', function() {
        if (this.checked) {
            // Setup timer for auto-update
            previewUpdateTimer = setInterval(function() {
                // Only update if preview is visible and not already generating
                if (bodyElement.classList.contains('preview-active') && !isGeneratingPreview) {
                    generatePdfPreview();
                }
            }, 5000); // Update every 5 seconds
        } else {
            // Clear auto-update timer
            clearInterval(previewUpdateTimer);
        }
    });
    
    // Setup initial auto-update timer only if checkbox is checked
    if (autoUpdateCheckbox.checked) {
        previewUpdateTimer = setInterval(function() {
            if (bodyElement.classList.contains('preview-active') && !isGeneratingPreview) {
                generatePdfPreview();
            }
        }, 5000);
    }
    
    // Monitor form changes to trigger updates
    const form = document.querySelector('form');
    const formInputs = form.querySelectorAll('input, textarea, select');
    
    formInputs.forEach(input => {
        input.addEventListener('change', function() {
            // If auto-update is enabled and preview is visible, schedule an update
            if (autoUpdateCheckbox.checked && bodyElement.classList.contains('preview-active')) {
                // Clear any existing timeout to prevent multiple rapid updates
                if (window.formChangeTimeout) {
                    clearTimeout(window.formChangeTimeout);
                }
                
                // Schedule an update in 1 second after the last change
                window.formChangeTimeout = setTimeout(function() {
                    if (!isGeneratingPreview) {
                        generatePdfPreview();
                    }
                }, 1000);
            }
        });
    });
    
    // Function to generate PDF preview
    function generatePdfPreview() {
        if (isGeneratingPreview) return;
        
        isGeneratingPreview = true;
        previewLoadingIndicator.style.display = 'flex';
        pdfPreviewFrame.style.display = 'none';
        previewErrorContainer.style.display = 'none';
        
        // Create FormData from the form
        const formData = new FormData(form);
        
        // Send AJAX request to generate preview
        fetch('/preview_pdf', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            isGeneratingPreview = false;
            
            if (data.success) {
                // Update iframe with new PDF URL
                pdfPreviewFrame.src = data.preview_url;
                pdfPreviewFrame.style.display = 'block';
                previewLoadingIndicator.style.display = 'none';
                
                // Update last update time
                const now = new Date();
                lastUpdateTime.textContent = now.toLocaleTimeString();
            } else {
                // Show error
                previewLoadingIndicator.style.display = 'none';
                previewErrorContainer.style.display = 'block';
                previewErrorMessage.textContent = data.error || 'Errore nella generazione dell\'anteprima';
            }
        })
        .catch(error => {
            isGeneratingPreview = false;
            previewLoadingIndicator.style.display = 'none';
            previewErrorContainer.style.display = 'block';
            previewErrorMessage.textContent = 'Errore di connessione al server';
            console.error('Error generating preview:', error);
        });
    }
    
    // Handle iframe load event
    pdfPreviewFrame.addEventListener('load', function() {
        // Check if the iframe loaded successfully
        try {
            // If we can access iframe content, it loaded successfully
            if (pdfPreviewFrame.contentDocument || pdfPreviewFrame.contentWindow) {
                previewLoadingIndicator.style.display = 'none';
                pdfPreviewFrame.style.display = 'block';
            }
        } catch (e) {
            // If we can't access iframe content (e.g., PDF), it's still fine
            previewLoadingIndicator.style.display = 'none';
            pdfPreviewFrame.style.display = 'block';
        }
    });
    
    // Handle window resize
    window.addEventListener('resize', function() {
        // Ensure proper layout on resize
        if (bodyElement.classList.contains('preview-active')) {
            // On smaller screens, might need additional adjustments
            if (window.innerWidth < 992) {
                // Mobile view adjustments if needed
            }
        }
    });
});
</script>
{% endblock %}